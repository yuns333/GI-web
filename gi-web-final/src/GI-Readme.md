# General Insight ReadMe



## General Insight란 무엇인가요?

Nginx로 웹 서비스를 제공하는 사람들에게 웹 서비스를 이용하는 사람들에 대한 정보를 제공하여 줍니다.

## General Insight에서 무엇을 제공하나요?

General Insight는 웹 서비스 제공자에게 3가지 Insight,  8가지 기능을 제공합니다. 첫 번째로는 운영 현황을 알 수 있는 전체/활성 유저 수, Top Pages, 웹 서비스 이용자들의 접속 브라우저 정보, 사용한 기기에 대한 정보를 Pie Chart, 꺾은선 그래프를 통하여 제공합니다. 두 번째로는 웹 서비스 유저가 사이트 내에서 어떠한 행동 패턴을 보이는지 Funnel Chart 제공합니다. 마지막으로 웹 서비스에 대한 마케팅의 효율성에 대한 정보를 유저의 Referrer를 tag cloud 형식으로 제공합니다.

## 어떻게 사용할 수 있나요?
1. General Insight가 제공하는 통계 기능을 모두 사용하기 위해서는, Nginx Configuration 파일의 Log Format을 수정해야됩니다.
2. nginx.conf 파일 내부의 http directive에,  아래와 같은 Log Format을 추가합니다. 기존의 Default Log Format에 더해 Cookie를 사용하여 유저 정보, 최초 방문 시간, 최근 방문 시간 등을 추가로 기록합니다.
~~~
log_format useridcomb '$remote_addr [$uid_got] [$cookie_firstvisit] [$time_local] '
    '"$request" $status $body_bytes_sent '
    '"$http_referer" "$http_user_agent"';
~~~
3. nginx.conf 파일 내부의 server directive를 아래와 같이 수정하여줍니다. 이때 access_log를 설정하는 부분에는 웹 서비스의 access_log가 저장될 Path를 설정하여 주시면 됩니다.
~~~
        userid on;
        userid_name uid;
        userid_path /;
        userid_domain 172.27.26.47;
        userid_expires 365d;
        userid_p3p     'policyref="/w3c/p3p.xml", CP="CUR ADM OUR NOR STA NID"';
       

        #error_page  404              /404.html;
        location ~ / {
        set $visited $cookie_firstvisit; 
        if ($visited = "") {
        add_header Set-Cookie "firstvisit=$time_local";
        }

        access_log  /path/to/your/accesslog   useridcomb;
        
        }

        #disable image logging
        location ~* \.(js|css|png|jpg|jpeg|gif|ico)$ {
                expires    +60d;
                access_log off;
        }

~~~
4. 웹 사이트가 있는 서버에 filebeat을 설치하여 줍시다.
5. filebeat.yml 파일 내부의 Filebeat inputs란을 아래와 같이 수정하여 줍니다.

~~~
#=========================== Filebeat inputs =============================

filebeat.inputs:

# Each - is an input. Most options can be set at the input level, so
# you can use different inputs for various configurations.
# Below are the input specific configurations.

- type: log

  # Change to true to enable this input configuration.
  enabled: true

  # Paths that should be crawled and fetched. Glob based paths.
  paths:
    - /path/to/your/accesslog
    #- c:\programdata\elasticsearch\logs\*

~~~

6. filebeat.yml 파일 내부의 Logstash output란을 아래와 같이 수정하여 줍니다. 이를 통해 여러분의 Log file이 General Insight 서비스의 Logstash Server로 전송됩니다.
~~~
#----------------------------- Logstash output --------------------------------
output.logstash:
  # The Logstash hosts
  hosts: ["172.27.26.41:5044"]

~~~

7. filebeat.yml 파일 내부의 Processors란을 아래와 같이 수정하여 줍니다. 이 때 myid란에는 여러분이  General Insight 서비스에 회원가입 할 때 당시의 ID, project란에는 General Insight 서비스를 이용하기 위해 추가한 Project의 이름을 기입하여 주시면 됩니다. 오타에 주의하시길 바랍니다. 
~~~
#================================ Processors =====================================

# Configure processors to enhance or manipulate events generated by the beat.

processors:
  - add_fields:
      fields:
        myid: yourid
        project: yourprojectname
  - add_host_metadata: ~
  - add_cloud_metadata: ~

~~~
8. filebeat를 실행하여 줍니다. 이제, 여러분의 웹 서비스 로그 분석이 시작되었습니다.